import Head from 'next/head'
import Image from 'next/image'
import styles from '../../styles/Home.module.css'
import { useRouter } from 'next/router'
import VoteButton from '../../Components/VoteButton'
import { useEffect, useState } from 'react'
import { setCookie, hasCookie } from 'cookies-next'

export default function QuestionPage() {
    const router = useRouter()
    const { id } = router.query
    let input = parseInt(id)
    const [disabled, setDisabled] = useState(false)
    const [question, SetQuestion] = useState('')
    const [options, SetOptions] = useState([])

    useEffect(() => {
        if (!router.isReady) {
            return
        }
        let Interval
        fetch('/api/question/' + input)
            .then((res) => res.json())
            .then((data) => {
                if (!data) {
                    return
                }

                SetQuestion(data?.prompt)
                //calls the fetch initially, as not to wait 5 seconds to see options appear 
                fetchOptions(data.id)

                Interval = setInterval(() => {
                    console.log("refetch")
                    fetchOptions(data.id)
                }, 3000);

            })
        //cleans up the interval upon demounting the component 
        return (() => {
            clearInterval(Interval)
        })


    }, [question, router.isReady])


    const fetchOptions = (questionId) => {
        if (questionId === undefined) {
            return
        }

        fetch('/api/option/' + questionId)
            .then((res) => res.json())
            .then((data) => {
                SetOptions(data)
                console.log(data)
            })

    }
    const HandleVote = (optionId) => {
        fetch('/api/option/vote/',
            {
                method: "POST",
                body: JSON.stringify({ id: optionId })
            })
            .then((res) => res.json())
            .then((data) => {

                console.log(data)
                //creates an expiration date of 1 day to plugin into setCookie
                let date = new Date();

                // add a day
                date.setDate(date.getDate() + 1);
                const options = {
                    expires: date
                }
                setCookie('voted/' + id, true, options)
            })
        //how to call fetch whenever you vote without rerendering options?
        //fetchOptions(optionId)

    }
    const HandleClick = (e) => {
        e.preventDefault()
        setDisabled(true)

        const voteData = e.currentTarget.value
        HandleVote(voteData)

    }
    //copies url to clipboard, share poll with friends 
    const copyToClipboard = () => {
        const el = document.createElement("input");
        el.value = window.location.href;
        document.body.appendChild(el);
        el.select();
        document.execCommand("copy");
        document.body.removeChild(el);

    }
    if (question === undefined) {
        return (
            <div className={styles.container}>
                <Head>
                    <title>Donkpoll</title>
                    <meta name="description" content="Generated by create next app" />
                    <link rel="icon" href="/favicon.ico" />
                </Head>

                <main className={styles.main}>
                    <div className={styles.grid}>

                        <h1 className={styles.title}>
                            No Question Found
                        </h1>





                    </div>


                </main>

                <footer className={styles.footer}>
                    <a
                        href="https://vercel.com?utm_source=create-next-app&utm_medium=default-template&utm_campaign=create-next-app"
                        target="_blank"
                        rel="noopener noreferrer"
                    >
                        Powered by{' '}
                        <span className={styles.logo}>
                            <Image src="/vercel.svg" alt="Vercel Logo" width={72} height={16} />
                        </span>
                    </a>
                </footer>
            </div>
        )
    }
    return (
        <div className={styles.container}>
            <Head>
                <title>Donkpoll</title>
                <meta name="description" content="Generated by create next app" />
                <link rel="icon" href="/favicon.ico" />
            </Head>

            <main className={styles.main}>
                <div className={styles.grid}>
                    <button onClick={copyToClipboard}>Share</button>

                    <h1 className={styles.title}>
                        {question}
                    </h1>

                    {options.map(item => {
                        return <VoteButton likes={item.likes} key={item.id} value={item.id} prompt={item.title} clickInstruction={HandleClick} disabled={hasCookie('voted/' + id) || disabled} />

                    })}



                </div>


            </main>

            <footer className={styles.footer}>
                <a
                    href="https://vercel.com?utm_source=create-next-app&utm_medium=default-template&utm_campaign=create-next-app"
                    target="_blank"
                    rel="noopener noreferrer"
                >
                    Powered by{' '}
                    <span className={styles.logo}>
                        <Image src="/vercel.svg" alt="Vercel Logo" width={72} height={16} />
                    </span>
                </a>
            </footer>
        </div>
    )
}
